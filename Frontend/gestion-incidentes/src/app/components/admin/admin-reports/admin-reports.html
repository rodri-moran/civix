<div class="reports-header mb-4">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb mb-1">
      <li class="breadcrumb-item">
        <a routerLink="/admin/dashboard">Inicio</a>
      </li>
      <li class="breadcrumb-item active">Reportes</li>
    </ol>
  </nav>
  <div class="d-flex align-items-center justify-content-between">
    <h2 class="fw-bold mb-0">Reportes</h2>

    <button
      class="btn btn-outline-light d-flex align-items-center gap-2"
      data-bs-toggle="dropdown"
      title="Filtrar reportes"
    >
      <i class="bi bi-filter"></i>
      Filtrar
    </button>
    <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0 rounded">
      <li>
        <a class="dropdown-item" (click)="filterByStatus('IN_PROCESS')">
          <i class="bi bi-person"></i> En proceso
        </a>
      </li>
      <li>
        <a class="dropdown-item" (click)="filterByStatus('PENDING')">
          <i class="bi bi-pencil-square"></i> Pendiente
        </a>
      </li>
      <li>
        <a class="dropdown-item" (click)="filterByStatus('RESOLVED')">
          <i class="bi bi-gear"></i> Resuelto
        </a>
      </li>
      <li>
        <a class="dropdown-item" (click)="filterByStatus('ALL')">
          <i class="bi bi-list"></i> Todos
        </a>
      </li>
    </ul>
  </div>
</div>
<main class="flex-grow-1 p-2">
  <div class="table-responsive d-none d-md-block border rounded">
    <table class="table table-striped table-hover shadow-sm align-middle">
      <thead class="table-dark text-center">
        <tr>
          <th>Título</th>
          <th>Dirección</th>
          <th>Estado</th>
          <th>Cuadrilla asignada</th>
          <th>Acciones</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let reporte of reports; let i = index" class="text-center">
          <td>{{ reporte.title }}</td>
          <td>{{ reporte.address }}</td>
          <td class="position-relative">
            <div class="d-inline-block dropdown">
              <!-- Botón con el estado actual -->
              <div
                class="badge rounded-pill px-3 py-2 status-drop d-flex align-items-center justify-content-center"
                [ngClass]="statusMap[reporte.status]?.class"
                (click)="toggleDropdown(reporte.id)"
              >
                {{ statusMap[reporte.status]?.text }}
                <i class="bi bi-chevron-down ms-1 small"></i>
              </div>

              <!-- Dropdown de estados -->
              <ul
                *ngIf="openDropdownId === reporte.id"
                class="dropdown-menu show position-absolute mt-1 shadow-sm border-0 rounded"
                style="min-width: 160px; z-index: 1050"
              >
                <li
                  *ngFor="let key of statusKeys"
                  (click)="onStatusSelect(reporte, key)"
                  class="dropdown-item d-flex align-items-center justify-content-start gap-2"
                  style="cursor: pointer"
                >
                  <span
                    class="badge rounded-circle"
                    [ngClass]="statusMap[key].class"
                    style="width: 12px; height: 12px"
                  ></span>
                  <span class="fw-semibold">{{ statusMap[key].text }}</span>
                </li>
              </ul>
            </div>
          </td>

          <td>
            <ng-container *ngIf="reporte.squad; else noSquad">
              {{ reporte.squad.name }}
            </ng-container>
            <ng-template #noSquad>
              <span class="text-muted">No asignado</span>
            </ng-template>
          </td>
          <td>
            <button
              class="btn btn-sm btn-outline-primary me-2 gap-1"
              (click)="openAssignModal(reporte)"
              data-bs-toggle="modal"
              data-bs-target="#assignModal"
            >
              <i class="bi bi-people"></i>
              Asignar
            </button>
            <!-- <button class="btn btn-sm btn-outline-primary me-2" (click)="openAssignModal(reporte)"
              data-bs-toggle="modal" data-bs-target="#assignModal">
              Asignar
            </button> -->

            <button
              class="btn btn-link text-secondary p-0"
              (click)="openDetailModal(reporte)"
              data-bs-toggle="modal"
              data-bs-target="#detailsModal"
              title="Ver detalles"
            >
              <i class="bi bi-eye fs-5"></i>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="d-block d-md-none">
    <div class="card mb-3" *ngFor="let reporte of reports">
      <div class="card-body">
        <h6 class="fw-bold">{{ reporte.title }}</h6>
        <p class="mb-1">{{ reporte.address }}</p>
        <span class="badge" [ngClass]="statusMap[reporte.status]?.class">
          {{ statusMap[reporte.status]?.text }}
        </span>
        <div class="mt-2">
          <button
            class="btn btn-sm btn-outline-primary"
            (click)="openDetailModal(reporte)"
            data-bs-toggle="modal"
            data-bs-target="#detailsModal"
          >
            Ver
          </button>

          <button
            class="btn btn-sm btn-outline-primary m-2 gap-1"
            (click)="openAssignModal(reporte)"
            data-bs-toggle="modal"
            data-bs-target="#assignModal"
          >
            <i class="bi bi-people"></i>
            Asignar
          </button>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="reports.length === 0" class="alert alert-info mt-3">No hay ningún reporte.</div>
</main>

<div
  class="modal fade"
  id="assignModal"
  tabindex="-1"
  aria-labelledby="assignModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <h5 class="modal-title fw-bold">Asignar cuadrilla</h5>
          <small class="text-muted">
            Esta acción asignará una cuadrilla al reporte seleccionado
          </small>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="mb-3">Selecciona una cuadrilla para el reporte:</p>
        <select class="form-select" [(ngModel)]="selectedSquadId">
          <option [ngValue]="undefined" disabled selected>
            Seleccione la cuadrilla responsable
          </option>
          <option *ngFor="let squad of squads" [ngValue]="squad.id">
            {{ squad.name }}
          </option>
        </select>
      </div>
      <div class="modal-footer d-flex justify-content-between">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>

        <button
          class="btn btn-primary px-4"
          [disabled]="!selectedSquadId || isAssigning"
          (click)="assignSquad()"
        >
          <span *ngIf="!isAssigning">Asignar cuadrilla</span>
          <span *ngIf="isAssigning" class="spinner-border spinner-border-sm"></span>
        </button>
      </div>
    </div>
  </div>
</div>
<!-- Modal de mensaje (éxito / error) -->
<div
  class="modal fade"
  id="messageModal"
  tabindex="-1"
  aria-labelledby="messageModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div
        class="modal-header"
        [ngClass]="{ 'bg-success text-white': isSuccess, 'bg-danger text-white': !isSuccess }"
      >
        <h5 class="modal-title" id="messageModalLabel">
          {{ isSuccess ? 'Éxito' : 'Error' }}
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Cerrar"
        ></button>
      </div>
      <div class="modal-body">
        {{ messageText }}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Aceptar</button>
      </div>
    </div>
  </div>
</div>

<!--Modal detalle reporte-->
<div
  class="modal fade"
  id="detailsModal"
  tabindex="-1"
  aria-labelledby="detailModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="detailModalLabel">Detalle del reporte</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <!-- Título -->
        <div class="mb-3">
          <h5 class="fw-bold text-primary">{{ reportToDetail?.title }}</h5>
        </div>

        <!-- Descripción -->
        <div class="mb-3">
          <label class="fw-semibold text-secondary">Descripción:</label>
          <p>{{ reportToDetail?.description }}</p>
        </div>

        <!-- Dirección y Estado -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="fw-semibold text-secondary">Dirección:</label>
            <p>{{ reportToDetail?.address }}</p>
          </div>
          <div class="col-md-6">
            <label class="fw-semibold text-secondary">Estado:</label>
            <span class="badge px-3 py-2 m-2" [ngClass]="statusMap[reportToDetail?.status!]?.class">
              {{ statusMap[reportToDetail?.status!]?.text || reportToDetail?.status }}
            </span>
          </div>
        </div>

        <!-- Fechas -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="fw-semibold text-secondary">Fecha de creación:</label>
            <p>{{ reportToDetail?.createdAt | date : 'dd/MM/yyyy HH:mm' : 'UTC-3' }}</p>
          </div>
        </div>

        <!-- Cuadrilla -->
        <div *ngIf="reportToDetail?.squad; else noSquad">
          <h6 class="fw-bold text-primary mt-3">Cuadrilla asignada</h6>
          <div class="row">
            <div class="col-md-4">
              <label class="fw-semibold text-secondary">Nombre:</label>
              <p>{{ reportToDetail?.squad?.name }}</p>
            </div>
            <div class="col-md-4">
              <label class="fw-semibold text-secondary">Área:</label>
              <p>{{ reportToDetail?.squad?.area }}</p>
            </div>
            <div class="col-md-4">
              <label class="fw-semibold text-secondary">Integrantes:</label>
              <p>{{ reportToDetail?.squad?.teamSize }}</p>
            </div>
          </div>
        </div>

        <ng-template #noSquad>
          <p class="text-muted fst-italic mt-3">No hay cuadrilla asignada aún.</p>
        </ng-template>

        <div class="mb-4">
          <label class="form-label">Ubicación</label>
          <div id="map"></div>
        </div>

        <!-- Imagen -->
        <div *ngIf="reportToDetail?.imageUrl" class="text-center mt-4">
          <img
            [src]="reportToDetail?.imageUrl"
            alt="Imagen del reporte"
            class="img-fluid rounded shadow-sm"
            style="max-height: 300px"
          />
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>
